\chapter{Propagation of electromagnetic showers}

\section{Electron and positron propagation in PROPOSAL}

\subsection{Ionization}

Ionization describes the inelastic collision of a particle with atomic electrons, leading to an energy loss of the primary particle.
For heavy, charged particles the average energy loss due to ionization is given by the Bethe formula.
PROPOSAL uses a modified Bethe formula, taking into account density correction effects, to describe the ionization losses for muons and tau particles \cite{Kohne:2013zbq}.
However, the Bethe formula can't be applied for electrons and positrons due to their lower mass as well as the indistinguishability of incoming electrons with atomic electrons.
Therefore, a separate treatment of the ionization losses for electrons and positrons is necessary.

\subsubsection{Theoretical description}

For energy transfers $\nu$ significantly greater than the atomic excitation levels, the atomic electrons can be considered as free and in rest.
In this case, the ionization process is essentially electron-electron scattering ($e^- + e^- \rightarrow e^- + e^-$), known as M{\o}ller scattering, or positron-electron scattering ($e^+ + e^- \rightarrow e^+ + e^-$), known as Bhabha scattering.
The two feynman diagrams contributing in leading order for M{\o}ller scattering are shown in figure \ref{fig:feynman_moller}, the differential cross section \cite{PhysRev.93.38} is given by
%
\begin{equation}
	\begin{split}
	\label{eqn:moller}
	\left(\frac{\symup{d}\sigma}{\symup{d}v}\right)_{\!\!-} = &\frac{2 \pi r_e^2 Z \gamma}{\beta^2(\gamma - 1)^2} \biggl[ \frac{(\gamma - 1)^2}{\gamma^2} + \frac{1}{\epsilon} \left( \frac{1}{\epsilon} - \frac{2\gamma - 1}{\gamma^2} \right) \\ &+ \frac{1}{1 - \epsilon} \left( \frac{1}{1 - \epsilon} - \frac{2 \gamma - 1}{\gamma^2} \right) \biggr]
	\end{split}
\end{equation}
%
with
%
\begin{align}
	\epsilon &= \frac{v E}{E - m_e},& \gamma &= \frac{E}{m_e}, & \beta &= \sqrt{1 - \frac{1}{\gamma^2}}, & v_{\text{max}} = \frac{1}{2} - \frac{m_e}{2 E}.
\end{align}

\begin{figure}
    \centering
    \input{content/feynman/feynman_moller.tex}
    \caption{Feynman diagrams in leading order for M{\o}ller scattering. The $t$-channel diagram is shown on the left, the $u$-channel diagram is shown on the right.}
    \label{fig:feynman_moller}
\end{figure}

For Bhabha scattering, the two feynman diagrams contributing in leading order are shown in figure \ref{fig:feynman_bhabha} and the differential cross section \cite{PhysRev.93.38} is given by
%
\begin{equation}
	\label{eqn:bhabha}
	\left(\frac{\symup{d}\sigma}{\symup{d}v}\right)_{\!\!+} = \frac{2 \pi r_e^2 Z \gamma}{(\gamma - 1)^2} \left[ \frac{1}{\beta^2 \epsilon^2} - \frac{B_1}{\epsilon} + B_2 - B_3 \epsilon + B_4 \epsilon^2 \right]
\end{equation}
%
with
%
\begin{align*}
	B_1 &= 2 - y^2, & B_2 &= (1 - 2y)(3 + y^2), \\ 
	B_3 &= (1-2y)^2 + (1 - 2y)^3, & B_4 &= (1 - 2y)^3 \\
	\intertext{and}
	y &= \frac{1}{\gamma + 1}, & v_{\text{max}} &= 1 - \frac{m_e}{E}.
\end{align*}

\begin{figure}
    \centering
    \input{content/feynman/feynman_bhabha.tex}
    \caption{Feynman diagrams in leading order for Bhabha scattering. The diagram describing the scattering process is shown on the left, the diagram describing the annihilation process is shown on the right.}
    \label{fig:feynman_bhabha}
\end{figure}

For energy transfers $\nu$ in the same order of magnitude as the atomic excitation levels, the explicit excitation probabilities $p(E, v)$ need to be considered.
Defining a threshold transfer energy $\nu_{\text{thres}}$ that is above the atomic excitation levels but below the energy cut in PROPOSAL, the continuous energy loss per distance due to ionization can be written as
%
\begin{equation}
	\label{eqn:ioniz_sum}
	-\left(\frac{\symup{d}E}{\symup{d}X}\right)_{\!\!\pm} \propto \int_{0}^{\sfrac{\nu_{\text{thres}}}{E}} v \cdot p(E, v) \, \symup{d}v + \int_{\sfrac{\nu_{\text{thres}}}{E}}^{v_{\text{cut}}} v \cdot \left(\frac{\symup{d}\sigma}{\symup{d}v}\right)_{\!\!\pm} \, \symup{d}v. 
\end{equation}
%
For an appropriate value of $\nu_{\text{thres}}$, certain approximations can be applied where \eqref{eqn:ioniz_sum} yields
%
\begin{equation}
	- \left(\frac{\symup{d}E}{\symup{d}X}\right)_{\!\!\pm} = \frac{2 \pi r_e^2 m_e}{\beta^2} \left[ \log{\left( \frac{2 m_e (\tau + 2)}{I} \right) + F^{\pm}(\tau, \Delta) - \delta } \right],
\end{equation}
%
also known as the Berger-Seltzer formula \cite{Hirayama:2005zm}, with
%
\begin{align}
	\tau &= \gamma - 1, & \Delta = \text{min}\left[ \frac{v_{\text{max}} E}{m_e}, \frac{v_{\text{cut}} E}{m_e} \right],
\end{align}
%
the mean ionization energy of the medium $I$ and the contribution from the density correction $\delta$ described in detail in \cite{Kohne:2013zbq}.
Furthermore, $F^{\pm}(\tau, \Delta)$ differs for electrons and positrons and is defined by
\begin{align}
	\begin{split}
	F^{+}(\tau, \Delta) = &\ln\left(\tau \Delta \right) - \frac{\beta^2}{\tau} \biggl[ \tau + 2 \Delta - \frac{3 \Delta^2 }{2} \\ &- (\Delta - \frac{\Delta^2}{3}) y^2 - ( \frac{\Delta^2}{2} - \frac{\tau\Delta^3}{3} + \frac{\Delta^4}{4} ) y^3 \biggr],
	\end{split}
	\\[2ex]
	\begin{split}
	F^{-}(\tau, \Delta) = &-1 - \beta^2 + \ln\left( (\tau - \Delta) \Delta \right) + \frac{\tau}{\tau - \Delta} \\ &+ \frac{1}{\gamma^2} \left[ \frac{\Delta^2}{2} + (2 \tau + 1) \log\left( 1 - \frac{\Delta}{\tau} \right) \right].
	\end{split}
\end{align}

\subsubsection{Implementation in PROPOSAL}


% sloppypar is needed here because otherwise \texttt{...} breaks the layout because it cant use hyphenation here
\begin{sloppypar}
The ionization cross sections for electrons and positrons described above can be used in PROPOSAL by setting the keyword \texttt{ioniz} in the configuration file to \texttt{IonizBergerSeltzerMoller} to use the parametrization for electrons or \texttt{IonizBergerSeltzerBhabha} to use the parametrization for positrons. 
\end{sloppypar}

To take into account the atomic excitation levels relevant for small energy transfers, the Berger-Seltzer formula, i.e.\ \eqref{eqn:ioniz_sum}, is used when calculating the continuous ionization losses.
When sampling the stochastic losses the differential cross section for M{\o}ller scattering \eqref{eqn:moller}, respectively the differential cross section for Bhabha scattering \eqref{eqn:bhabha}, is used directly since the contributions from small energy transfers are negligible here.

Figure \ref{fig:dEdx_ionization} shows the differences in the continuous ionization loss for electrons and positrons when using the appropriate Berger-Seltzer formula compared to the Bethe formula.
It can be seen that the influence is up to $\SI{20}{\percent}$ for high energies.
%
\begin{figure}
    \centering
    \includegraphics[scale=1]{build/dEdx_ionization.pdf}
    \caption{Average energy loss of electrons and positrons in air due to ionization. Note that the Bethe formula is, unlike the Berger-Seltzer formula, identical for electrons and positrons.}
    \label{fig:dEdx_ionization}
\end{figure}
%
Furthermore, the Berger-Seltzer formula, compared to the Bethe formula which is independent of the particle charge, differentiates between electrons and positrons.
While the contribution from the atomic excitation levels is, as a good approximation, identical for electrons and positrons, the contribution from high energy transfers differs.
Here, if the ingoing particle is an electron, it is indistinguishable from the atomic electron after the ionization process.
Therefore, the electron with the higher energy after the interaction is by definition the initial particle.
A positron as an ingoing particle however is always distinguishable from the atomic electron and can therefore be the particle with the lower energy after the interaction.

\subsection{Bremsstrahlung}

Bremsstrahlung describes the energy loss of a charged particle in the field of an atomic nucleus $Z$ where a photon is emitted, i.e.\
%
\begin{align*}
	e^{\pm} + Z \rightarrow e^{\pm} + Z + \gamma.
\end{align*}
%
Since the process has a $m^{-2}$ mass dependency, bremsstrahlung is the dominant interaction for high energy electrons and positrons.
It is therefore relevant to provide an accurate description of the bremsstrahlung cross section.

For electrons with high energies, \cite{Kohne:2013zbq} recommends the usage of the Complete Screening parametrization which is already implemented in PROPOSAL.
This ultra-relativistic cross section, given and described by \cite{RevModPhys.46.815}, uses Coulomb corrections as well as the assumption that the screening of the Coulomb field of the nucleus by the atomic electron cloud is maximal, which is an appropriate approximation for high-energy electrons.

EGS uses an alternative parametrization of the bremsstrahlung interaction, including empirical corrections for low energies.
This parametrization is implemented in PROPOSAL to examine the differences between the cross sections provided by PROPOSAL and EGS as well as the influence from the low energy corrections.

\subsubsection{Theoretical description}



The bremsstrahlung cross section provided by EGS5, which is described in detail by \cite{Hirayama:2005zm}, is split into a high-energy and a low-energy part with a discrete cut at $\SI{50}{\mega\electronvolt}$.

For $E > \SI{50}{\mega\electronvolt}$, the ultra-relativistic differential cross section, comparable to the Complete Screening parametrization in PROPOSAL, is given by
%
\begin{equation}
	\label{eqn:brems_high}
	\begin{split}
	\frac{\symup{d}\sigma}{\symup{d}v} = &\frac{Z (Z + \xi(Z)) r_e^2 \alpha}{v} \biggl[ (2 - 2 v + v^2) \left( \Phi_1(x) - \frac{4}{3} \ln(Z) - 4 f_c(Z) \right) \\ &- \frac{2}{3} (1 - v) \left( \Phi_2(x) - \frac{4}{3} \ln(Z) - 4 f_c(Z) \right) \biggl]
	\end{split}
\end{equation}
%
with
%
\begin{align}
	x &= 136 Z^{-\sfrac{1}{3}} \frac{2 \delta}{m_e}, & \delta &= \frac{m_e^2 v}{2 E (1 - v)}.
\end{align}
%
The functions $\Phi_1(x)$, $\Phi_2(x)$ describe the screening effects and are given by
%
\begin{align}
	\Phi_1(x) &= 
	\begin{cases}
		20.867 - 3.242 x + 0.625 x^2, & x \leq 1,\\
		21.12 - 4.184 \ln(x + 0.952), & x > 1,\\
	\end{cases}\\
	\Phi_2(x) &= 
	\begin{cases}
		20.029 - 1.930 x - 0.086 x^2, & x \leq 1,\\
		21.12 - 4.184 \ln(x + 0.952), & x > 1,\\
	\end{cases}
\end{align}
%
which is an analytical approximation of the Thomas-Fermi form factors.
Furthermore, $f_c(Z)$ describes the Coulomb correction and is approximated in an analytical form by
%
\begin{equation}
	f_c(Z) \approx a^2 \left[ \frac{1}{1 + a^2} + 0.20206 - 0.0369a^2 + 0.0083 a^4 - 0.002 a^6 \right]
\end{equation}
%
with $a = \alpha Z$.
The parameter 
%
\begin{equation}
	\xi(Z) = \frac{L_\text{rad}^{\prime}(Z)}{L_\text{rad}(Z) - f_c(Z)} 
\end{equation}
%
accounts for atomic electron effects where the radiation logarithms are given by
\begin{align}
	L_\text{rad}^{\prime} &=
	\begin{cases}
		\ln(1194 Z^{-\sfrac{2}{3}}) & \text{if $Z > 4$}, \\
		5.924 & \text{if $Z = 4$}, \\
		5.805 & \text{if $Z = 3$}, \\
		5.621 & \text{if $Z = 2$}, \\
		6.144 & \text{if $Z = 1$},
	\end{cases} \\
	L_\text{rad} &=
	\begin{cases}
		\ln(184.15 Z^{-\sfrac{1}{3}}) & \text{if $Z > 4$}, \\
		4.710 & \text{if $Z = 4$}, \\
		4.740 & \text{if $Z = 3$}, \\
		4.790 & \text{if $Z = 2$}, \\
		5.310 & \text{if $Z = 1$}.
	\end{cases}
\end{align}

For $E < \SI{50}{\mega\electronvolt}$, the differential bremsstrahlung cross section is given by
%
\begin{equation}
	\label{eqn:brems_low}
	\begin{split}
	\frac{\symup{d}\sigma}{\symup{d}v} = &\frac{A^{\prime}(E, Z) Z (Z + \xi(Z)) r_e^2 \alpha}{v} \biggl[ (2 - 2 v + v^2) \left( \Phi_1(x) - \frac{4}{3} \ln(Z) \right) \\ &- \frac{2}{3} (1 - v) \left( \Phi_2(x) - \frac{4}{3} \ln(Z) \right) \biggl]
	\end{split}	
\end{equation}
%
where a density correction factor $A^{\prime}(E,Z)$ has been introduced.
This factor $A^{\prime}(E,Z)$ rescales the differential cross section to be in agreement with the empirical average energy losses per distance from \cite{icru37}, the detailed procedure to obtain this correction is described in \cite{pirs}.
It should be noted that this factor is only a normalization factor and is therefore not affecting the shape of the energy loss distribution itself.

\subsubsection{Implementation in PROPOSAL}

%%% interpolation table for 14 Z values for 115 energies between 1 keV and 10 GeV

%
\begin{figure}
    \centering
    \includegraphics[scale=1]{build/dEdx_brems.pdf}
    \caption{Average energy loss of electrons and positrons in air due to bremsstrahlung.}
    \label{fig:dEdx_brems}
\end{figure}
%

\subsection{Electron-positron annihilation}

\section{Photon propagation in PROPOSAL}

\subsection{Pair production by photons}

\subsection{Compton scattering}

\subsection{Cross checks}

\subsection{Electromagnetic shower propagation with PROPOSAL}