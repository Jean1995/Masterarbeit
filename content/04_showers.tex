\chapter{Propagation of electromagnetic showers}

\label{sec:shower}

As described in section \ref{sec:corsika}, CORSIKA 7 uses the software package EGS4 to simulate the electromagnetic components of extensive air showers.
However, the development of the original EGS code ended with the release of EGS4, although other groups continued working on the given code foundation \cite{Hirayama:2005zm, Kawrakow2016TheEC}.

For the currently developed new version CORSIKA 8, up-to-date models to describe the electromagnetic shower components are needed.
As an actively maintained propagation program written in a modern programming language, PROPOSAL represents a possible choice for this purpose.
As a requirement, PROPOSAL needs to be able to propagate electrons, positrons and photons.

In the following section, the measures taken to improve the propagation of electrons and positrons as well as the measures taken to realize the propagation of photons are described.
Furthermore, as a proof of concept, the simulation of photon-induced electromagnetic showers with PROPOSAL using the newly integrated cross sections are presented.

Definitions and numerical values of variables are, unless otherwise specified, listed, if necessary with their corresponding numerical values, in appendix \ref{sec:constants}.

\section{Electron and positron propagation in PROPOSAL}

Although most processes relevant for electron and positron propagation are already implemented in PROPOSAL, the included cross sections are optimized for muon and tau propagation, requiring some parametrizations to be adapted.

The currently used parametrization of ionization doesn't provide correct results when applied to electrons and positrons, a correct parametrization is therefore implemented as described in section \ref{sec:ionization}.
Since bremsstrahlung effects are dominant for electrons and positrons, an optimized parametrization, as described in section \ref{sec:brems}, is added to PROPOSAL.
For positrons, annihilation with atomic electrons is a new interaction that is not described by other processes, the treatment of electron-positron annihilation in PROPOSAL is presented in section \ref{sec:annihilation}.

\label{sec:electronprop}

\subsection{Ionization}
\label{sec:ionization}

Ionization describes the inelastic collision of a particle with atomic electrons, leading to an energy loss of the primary particle.
For heavy, charged particles the average energy loss due to ionization is given by the Bethe formula.
PROPOSAL uses a modified Bethe formula, taking into account density correction effects, to describe the ionization losses for muons and tau particles \cite{Kohne:2013zbq, Rossi:99081, PhysRevD.98.030001}.
However, the Bethe formula can't be applied for electrons and positrons due to their lower mass as well as the indistinguishability of incoming electrons with atomic electrons \cite{10027956359}.
Therefore, a separate treatment of the ionization losses for electrons and positrons is necessary.

\subsubsection{Theoretical description}

For energy transfers $\nu$ significantly greater than the atomic excitation levels, the atomic electrons can be considered as free and in rest.
In this case, the ionization process is essentially electron-electron scattering ($e^- + e^- \rightarrow e^- + e^-$), known as M{\o}ller scattering, or positron-electron scattering ($e^+ + e^- \rightarrow e^+ + e^-$), known as Bhabha scattering.
The two Feynman diagrams contributing in leading order for M{\o}ller scattering are shown in figure \ref{fig:feynman_moller}, the differential cross section \cite{PhysRev.93.38} is given by
%
\begin{equation}
	\begin{split}
	\label{eqn:moller}
	\left(\frac{\symup{d}\sigma}{\symup{d}v}\right)_{\!\!-} &= \frac{2 \pi r_e^2 Z \gamma}{\beta^2(\gamma - 1)^2} \biggl[ \frac{(\gamma - 1)^2}{\gamma^2} + \frac{1}{\epsilon} \left( \frac{1}{\epsilon} - \frac{2\gamma - 1}{\gamma^2} \right) \\ &\quad+ \frac{1}{1 - \epsilon} \left( \frac{1}{1 - \epsilon} - \frac{2 \gamma - 1}{\gamma^2} \right) \biggr]
	\end{split}
\end{equation}
%
with
%
\begin{align}
	\epsilon &= \frac{v E}{E - m_e},& \gamma &= \frac{E}{m_e}, & \beta &= \sqrt{1 - \frac{1}{\gamma^2}}, & v_{\text{max}} = \frac{1}{2} - \frac{m_e}{2 E}.
\end{align}

\begin{figure}
    \centering
    \input{content/feynman/feynman_moller.tex}
    \caption{Feynman diagrams in leading order for M{\o}ller scattering. The $t$-channel diagram is shown on the left, the $u$-channel diagram is shown on the right.}
    \label{fig:feynman_moller}
\end{figure}

For Bhabha scattering, the two Feynman diagrams contributing in leading order are shown in figure \ref{fig:feynman_bhabha} and the differential cross section \cite{PhysRev.93.38} is given by
%
\begin{equation}
	\label{eqn:bhabha}
	\left(\frac{\symup{d}\sigma}{\symup{d}v}\right)_{\!\!+} = \frac{2 \pi r_e^2 Z \gamma}{(\gamma - 1)^2} \left[ \frac{1}{\beta^2 \epsilon^2} - \frac{B_1}{\epsilon} + B_2 - B_3 \epsilon + B_4 \epsilon^2 \right]
\end{equation}
%
with
%
\begin{align*}
	B_1 &= 2 - y^2, & B_2 &= (1 - 2y)(3 + y^2), \\ 
	B_3 &= (1-2y)^2 + (1 - 2y)^3, & B_4 &= (1 - 2y)^3 \\
	\intertext{and}
	y &= \frac{1}{\gamma + 1}, & v_{\text{max}} &= 1 - \frac{m_e}{E}.
\end{align*}

\begin{figure}
    \centering
    \input{content/feynman/feynman_bhabha.tex}
    \caption{Feynman diagrams in leading order for Bhabha scattering. The diagram describing the scattering process is shown on the left, the diagram describing the annihilation process is shown on the right.}
    \label{fig:feynman_bhabha}
\end{figure}

For energy transfers $\nu$ in the same order of magnitude as the atomic excitation levels, the explicit excitation probabilities $p(E, v)$ need to be considered.
Defining a threshold transfer energy $\nu_{\text{thres}}$ that is above the atomic excitation levels but below the energy cut in PROPOSAL, the continuous energy loss per distance due to ionization can be written as
%
\begin{equation}
	\label{eqn:ioniz_sum}
	-\left(\frac{\symup{d}E}{\symup{d}X}\right)_{\!\!\pm} \propto \int_{0}^{\sfrac{\nu_{\text{thres}}}{E}} v \cdot p(E, v) \, \symup{d}v + \int_{\sfrac{\nu_{\text{thres}}}{E}}^{v_{\text{cut}}} v \cdot \left(\frac{\symup{d}\sigma}{\symup{d}v}\right)_{\!\!\pm} \, \symup{d}v. 
\end{equation}
%
For an appropriate value of $\nu_{\text{thres}}$, certain approximations can be applied where \eqref{eqn:ioniz_sum} yields \cite{PhysRev.93.38}
%
\begin{equation}
	- \left(\frac{\symup{d}E}{\symup{d}X}\right)_{\!\!\pm} = \frac{2 \pi r_e^2 m_e}{\beta^2} \left[ \log{\left( \frac{2 m_e (\tau + 2)}{I} \right) + F^{\pm}(\tau, \Delta) - \delta } \right],
\end{equation}
%
also known as the Berger-Seltzer formula \cite{Hirayama:2005zm}, with
%
\begin{align}
	\tau &= \gamma - 1, & \Delta = \text{min}\left[ \frac{v_{\text{max}} E}{m_e}, \frac{v_{\text{cut}} E}{m_e} \right],
\end{align}
%
the mean ionization energy of the medium $I$ and the contribution from the density correction $\delta$ described in detail in \cite{Kohne:2013zbq}.
Furthermore, $F^{\pm}(\tau, \Delta)$ differs for electrons and positrons and is defined by
\begin{align}
	\begin{split}
	F^{+}(\tau, \Delta) &= \ln\left(\tau \Delta \right) - \frac{\beta^2}{\tau} \biggl[ \tau + 2 \Delta - \frac{3 \Delta^2 }{2} \\ &\quad- (\Delta - \frac{\Delta^2}{3}) y^2 - ( \frac{\Delta^2}{2} - \frac{\tau\Delta^3}{3} + \frac{\Delta^4}{4} ) y^3 \biggr],
	\end{split}
	\\[2ex]
	\begin{split}
	F^{-}(\tau, \Delta) &= -1 - \beta^2 + \ln\left( (\tau - \Delta) \Delta \right) + \frac{\tau}{\tau - \Delta} \\ &\quad+ \frac{1}{\gamma^2} \left[ \frac{\Delta^2}{2} + (2 \tau + 1) \log\left( 1 - \frac{\Delta}{\tau} \right) \right].
	\end{split}
\end{align}

\subsubsection{Implementation in PROPOSAL}


% sloppypar is needed here because otherwise \texttt{...} breaks the layout because it cant use hyphenation here
\begin{sloppypar}
The ionization cross sections for electrons and positrons described above can be used in PROPOSAL by setting the keyword \texttt{ioniz} in the configuration file to \texttt{IonizBergerSeltzerMoller} to use the parametrization for electrons or \texttt{IonizBergerSeltzerBhabha} to use the parametrization for positrons. 
\end{sloppypar}

To take into account the atomic excitation levels relevant for small energy transfers, the Berger-Seltzer formula, i.e.\ \eqref{eqn:ioniz_sum}, is used when calculating the continuous ionization losses.
When sampling the stochastic losses the differential cross section for M{\o}ller scattering \eqref{eqn:moller}, respectively the differential cross section for Bhabha scattering \eqref{eqn:bhabha}, is used directly since the contributions from small energy transfers are negligible here.

Figure \ref{fig:dEdx_ionization} shows the differences in the continuous ionization loss for electrons and positrons when using the appropriate Berger-Seltzer formula compared to the Bethe formula.
It can be seen that the influence is up to $\SI{5}{\percent}$ for small energies.
%
\begin{figure}
    \centering
    \includegraphics[scale=1]{build/dEdx_ionization.pdf}
    \caption{Average energy loss of electrons and positrons in air due to ionization. Note that the Bethe formula is, unlike the Berger-Seltzer formula, identical for electrons and positrons. The default Bethe parametrization used in PROPOSAL includes NLO inelastic bremsstrahlung corrections \cite{Kohne:2013zbq}. For an easier comparison to the Berger-Seltzer formula (which does not consider NLO corrections), the Bethe formula without NLO corrections has been calculated as well. In the lower half of the figure, this version of the Bethe formula is compared to the Berger-Seltzer formula.}
    \label{fig:dEdx_ionization}
\end{figure}
%
Furthermore, the Berger-Seltzer formula, compared to the Bethe formula which is independent of the particle charge, takes differences between ionization energy losses of electrons and positrons into account.
While the contribution from the atomic excitation levels is, as a good approximation, identical for electrons and positrons \cite{PhysRev.93.38}, the contribution from high energy transfers differs.
Here, if the ingoing particle is an electron, it is indistinguishable from the atomic electron after the ionization process.
Therefore, the electron with the higher energy after the interaction is by definition the initial particle.
A positron as an ingoing particle however is always distinguishable from the atomic electron and can therefore be the particle with the lower energy after the interaction.

\subsection{Bremsstrahlung}
\label{sec:brems}

Bremsstrahlung describes the energy loss of a charged particle in the field of an atomic nucleus $Z$ where a photon is emitted, i.e.\
%
\begin{align*}
	e^{\pm} + Z \rightarrow e^{\pm} + Z + \gamma.
\end{align*}
%
Since the process has a $m^{-2}$ mass dependency, bremsstrahlung is the dominant interaction for high energy electrons and positrons.
It is therefore relevant to provide an accurate description of the bremsstrahlung cross section.

For electrons with high energies, \cite{Kohne:2013zbq} recommends the usage of the Complete Screening parametrization which has already been implemented in PROPOSAL.
This ultra-relativistic cross section, given and described by \cite{RevModPhys.46.815}, uses Coulomb corrections as well as the assumption that the screening of the Coulomb field of the nucleus by the atomic electron cloud is maximal, which is an appropriate approximation for high-energy electrons.

EGS uses an alternative parametrization of the bremsstrahlung interaction, including empirical corrections for low energies \cite{Hirayama:2005zm}.
This parametrization is implemented in PROPOSAL to examine the differences between the cross sections provided by PROPOSAL and EGS as well as the influence from the low energy corrections.

\subsubsection{Theoretical description}

The bremsstrahlung cross section provided by EGS5, which is described in detail by \cite{Hirayama:2005zm}, is split into a high-energy and a low-energy part with a discrete cut at $\SI{50}{\mega\electronvolt}$.

For $E > \SI{50}{\mega\electronvolt}$, the ultra-relativistic differential cross section, comparable to the Complete Screening parametrization in PROPOSAL, is given by
%
\begin{equation}
	\label{eqn:brems_high}
	\begin{split}
	\frac{\symup{d}\sigma}{\symup{d}v} &= \frac{Z (Z + \xi(Z)) r_e^2 \alpha}{v} \biggl[ (2 - 2 v + v^2) \left( \Phi_1(x) - \frac{4}{3} \ln(Z) - 4 f_c(Z) \right) \\ &\quad- \frac{2}{3} (1 - v) \left( \Phi_2(x) - \frac{4}{3} \ln(Z) - 4 f_c(Z) \right) \biggl]
	\end{split}
\end{equation}
%
with
%
\begin{align}
	x &= 136 Z^{-\sfrac{1}{3}} \frac{2 \delta}{m_e}, & \delta &= \frac{m_e^2 v}{2 E (1 - v)}.
\end{align}
%
The functions $\Phi_1(x)$, $\Phi_2(x)$ describe the screening effects and are given by
%
\begin{align}
	\Phi_1(x) &= 
	\begin{cases}
		20.867 - 3.242 x + 0.625 x^2 & \text{if $x \leq 1$},\\
		21.12 - 4.184 \ln(x + 0.952) & \text{if $x > 1$},\\
	\end{cases}\\
	\Phi_2(x) &= 
	\begin{cases}
		20.029 - 1.930 x - 0.086 x^2 & \text{if $x \leq 1$},\\
		21.12 - 4.184 \ln(x + 0.952) & \text{if $x > 1$},\\
	\end{cases}
\end{align}
%
which is an analytical approximation of the Thomas-Fermi form factors.
Furthermore, $f_c(Z)$ describes the Coulomb correction and is approximated in an analytical form by
%
\begin{equation}
	f_c(Z) \approx a^2 \left[ \frac{1}{1 + a^2} + 0.20206 - 0.0369a^2 + 0.0083 a^4 - 0.002 a^6 \right]
\end{equation}
%
with $a = \alpha Z$.
The parameter 
%
\begin{equation}
	\xi(Z) = \frac{L_\text{rad}^{\prime}(Z)}{L_\text{rad}(Z) - f_c(Z)} 
\end{equation}
%
with the radiation logarithms
\begin{align}
	L_\text{rad}^{\prime} &=
	\begin{cases}
		\ln(1194 Z^{-\sfrac{2}{3}}) & \text{if $Z > 4$}, \\
		5.924 & \text{if $Z = 4$}, \\
		5.805 & \text{if $Z = 3$}, \\
		5.621 & \text{if $Z = 2$}, \\
		6.144 & \text{if $Z = 1$},
	\end{cases} \\
	L_\text{rad} &=
	\begin{cases}
		\ln(184.15 Z^{-\sfrac{1}{3}}) & \text{if $Z > 4$}, \\
		4.710 & \text{if $Z = 4$}, \\
		4.740 & \text{if $Z = 3$}, \\
		4.790 & \text{if $Z = 2$}, \\
		5.310 & \text{if $Z = 1$}.
	\end{cases}
\end{align}
accounts for atomic electron effects.

For $E < \SI{50}{\mega\electronvolt}$, the differential bremsstrahlung cross section is given by
%
\begin{equation}
	\label{eqn:brems_low}
	\begin{split}
	\frac{\symup{d}\sigma}{\symup{d}v} &= \frac{A^{\prime}(E, Z) Z (Z + \xi(Z)) r_e^2 \alpha}{v} \biggl[ (2 - 2 v + v^2) \left( \Phi_1(x) - \frac{4}{3} \ln(Z) \right) \\ &\quad- \frac{2}{3} (1 - v) \left( \Phi_2(x) - \frac{4}{3} \ln(Z) \right) \biggl]
	\end{split}	
\end{equation}
%
where a density correction factor $A^{\prime}(E,Z)$ has been introduced.
This factor $A^{\prime}(E,Z)$ rescales the differential cross section to be in agreement with the empirical average energy losses per distance from \cite{icru37}, the detailed procedure to obtain this correction is described in \cite{pirs}.
It should be noted that this factor is only a normalization factor and is therefore not affecting the shape of the energy loss distribution itself.

\subsubsection{Implementation in PROPOSAL}

% sloppypar is needed here because otherwise \texttt{...} breaks the layout because it cant use hyphenation here
\begin{sloppypar}
To use the bremsstrahlung cross section described above in PROPOSAL, the keyword \texttt{brems} in the configuration file can be set to \texttt{BremsElectronScreening}.
\end{sloppypar}

The values for $A^{\prime}(E,Z)$ are provided as a two-dimensional table in $\ln(Z)$ and $E$ with $\num{14}$ entries in $\ln(Z)$ and, for each $\ln(Z)$, $\num{115}$ entries in $E$.  
PROPOSAL uses a two-dimensional interpolation routine to obtain the correction factor for an arbitrary $Z$, $E$ from the discrete tables values.

\begin{figure}
    \centering
    \includegraphics[scale=1]{build/dEdx_brems.pdf}
    \caption{Comparison of the average energy loss of electrons in air due to bremsstrahlung between the parametrization adapted from EGS (Electron Screening) and two alternative parametrizations (Complete Screening, Andreev Bezrukov Bugaev). The dashed red line highlights the cut applied in the Electron Screening parametrization between the high-energy and low-energy part.}
    \label{fig:dEdx_brems}
\end{figure}


Figure \ref{fig:dEdx_brems} shows a comparison of the average energy loss for electrons\footnote{The bremsstrahlung cross section is identical for positrons which is valid regarding lowest order calculations in $\alpha$ \cite{RevModPhys.46.815}.} loss due to bremsstrahlung when using different differential cross sections.
For very high energies, all parametrizations yield comparable results.
However, differences exceeding a factor of $\num{1.5}$ can be seen for lower energies, especially in the domain of several \si{\mega\electronvolt}.
It is particularly noticeable that the results from the Electron Screening parametrization are in better agreement with the Andreev Bezrukov Bugaev parametrization than the Complete Screening parametrization, although the latter has been recommended for (high energy) electrons.

Furthermore, a discontinuity at $\SI{50}{\mega\electronvolt}$ when using the Electron Screening parametrization is notable.
This behavior results from the fact that the correction factor $A^{\prime}(E,Z)$ is set to $1$ for $E > \SI{50}{\mega\electronvolt}$ although this approximation is invalid according to the empirical data which imply that $A^{\prime}(E,Z) \neq 1$ for energies above the cut.
A smoothing of the correction parameter around $\SI{50}{\mega\electronvolt}$ could remove the unphysical discontinuity, however, such a method would be arbitrary to a certain extend.
Alternatively, using a differential cross section applicable for all energies without relying on empirical correction factors would be preferable for PROPOSAL. 

\subsection{Electron-positron annihilation}
\label{sec:annihilation}
\subsubsection{Theoretical description}

Electron-positron annihilation, only called annihilation in the further course of this section, describes the collision of a positron with an atomic electron where both particles annihilate and a pair of photons is created, i.e\ the process
%
\begin{align*}
	e^+ + e^- \rightarrow \gamma + \gamma,
\end{align*}
which is therefore only relevant when propagating positrons.
%
The Feynman diagram describing this process in leading order is shown in figure \ref{fig:feynman_annihilation}.
%
\begin{figure}
    \centering
    \input{content/feynman/feynman_annihilation.tex}
    \caption{Feynman diagram in leading order for electron-positron annihilation.}
    \label{fig:feynman_annihilation}
\end{figure}

Under the assumption that the atomic electron is initially free and at rest, which is a good approximation for positrons with energies high compared to atomic binding energies, the differential annihilation cross section is described by the Heitler formula \cite{heitler1954quantum} given by \cite{Hirayama:2005zm}
%
\begin{equation}
	\label{eqn:heitler_annihilation}
	\frac{\symup{d}\sigma}{\symup{d}\epsilon} = \frac{\pi r_e^2}{\gamma - 1} \frac{1}{\epsilon} \left[ 1 + \frac{2 \gamma}{(\gamma + 1)^2} - \epsilon - \frac{1}{(\gamma + 1)^2} \frac{1}{\epsilon} \right].
\end{equation}
%

Here, $\gamma$ and $\epsilon$ are defined by
%
\begin{align*}
	\gamma &= \frac{E}{m}, & \epsilon &= \frac{E_{\gamma, 1}}{E + m_e},
\end{align*}
%
meaning that $\epsilon$ describes the ratio of the energy transfer to one of the created photons to the available energy, i.e.\ the positron energy and the mass of the atomic electron.

Since annihilation describes a two-body interaction, the kinematics of the final state are fully determined for a given $E$ and $\epsilon$.
Considering a general two-body interaction 
%
\begin{align*}
	X_1 + X_2 \rightarrow X_3 + X_4
\end{align*}
%
with the corresponding energies $E_i$, masses $m_i$ and absolute momenta $p_i$ of the particles involved, applying the conservation of four-momentum (i.e.\ conservation of energy and conservation of 3-space momentum) leads to the relation \cite{Hirayama:2005zm}
%
\begin{equation}
	\label{eqn:2to2process_angle}
	\cos(\theta_3) = \frac{m_4^2 - m_1^2 - m_2^2 - m_3^2 + 2 (E_1 + m_2) E_3 - 2 E_1 m_2}{2 p_1 p_3}
\end{equation}
%
for the frame where $X_2$ is in rest with the angle $\theta_3$ between the incident particle $X_1$ and the final particle $X_3$.
For annihilation, using
%
\begin{align*}
	E_1 &= E, & m_1 &= m_2 = m_e, \\
	E_2 &= m_e, & m_3 &= m_4 = 0, \\
	E_3 &= \epsilon (E + m_e),
\end{align*}
%
yields the relation
%
\begin{equation}
	\label{eqn:annihilation_angle_1}
	\cos(\theta_3) = \frac{\epsilon (\gamma + 1) - 1}{\epsilon\sqrt{\gamma^2 - 1}}
\end{equation}
%
as well as, using a similar calculation, the relation
%
\begin{equation}
	\label{eqn:annihilation_angle_2}
	\cos(\theta_4) = \frac{(1 - \epsilon) (\gamma + 1) - 1}{(1-\epsilon)\sqrt{\gamma^2 - 1}}.
\end{equation}
%
Furthermore, setting $\cos(\theta_3) = \pm \num{1}$ in \ref{eqn:annihilation_angle_1} yields the kinematic limits for $\epsilon$
%
\begin{align}
	\epsilon_{\text{max/min}} = \frac{1}{2} \pm \frac{1}{2} \sqrt{\frac{\gamma - 1}{\gamma + 1}}.
\end{align}
%

\subsubsection{Implementation in PROPOSAL}

% sloppypar is needed here because otherwise \texttt{...} breaks the layout because it cant use hyphenation here
\begin{sloppypar}
The annihilation cross section described in the previous section, which is per default disabled in PROPOSAL, can be enabled by setting the keyword \texttt{annihilation} in the configuration file to \texttt{AnnihilationHeitler}.
\end{sloppypar}

The annihilation process is a catastrophic loss, similar to the weak interaction whose treatment is described in section \ref{sec:weak_implementation}, since the initial positron ceases to exist after the interaction.
Accordingly, treating this process as continuous would be unphysical.
Instead, the annihilation interaction is always stochastic and the relative energy loss of the initial positron is always $v=1$ since all energy is transferred to the created photon pair.
This requires adjustments to the simulation of the stochastic energy loss in the propagation algorithm of PROPOSAL which is described in section \ref{sec:algorithm}.

To calculate the total stochastic cross section $\sigma_{\text{stoch}}$ for annihilation, the differential cross section \eqref{eqn:heitler_annihilation} is integrated over the entire kinematic range of $\epsilon$.
Since $v=1$, the energy transfer doesn't need to be calculated here.
Instead, $\epsilon$ needs to be sampled by solving the integral equation
%
\begin{equation}
	\frac{1}{\sigma_{\text{stoch}}} \int_{\epsilon_{\text{min}}}^{\epsilon} \frac{\symup{d}\sigma}{\symup{d}\epsilon} \, \symup{d}\epsilon = \xi
\end{equation}
%
for $\epsilon$ with a random number $\xi \in \left[0,1\right)$.
With the sampled $\epsilon$, the energies of the created photons are set to
%
\begin{align}
	E_{\gamma,1} &= (E + m) \epsilon, & E_{\gamma,2} &= (E + m) (1 - \epsilon).
\end{align}
%
Furthermore, the photons inherit the direction of the initial positron with an additional deflection of a polar angle $\theta$ according to \eqref{eqn:annihilation_angle_1} and \eqref{eqn:annihilation_angle_2} as well as an azimuth angle $\Phi$ sampled via
%
\begin{align}
	\Phi_{\gamma,1} &= 2 \pi \xi, & \Phi_{\gamma,2} &= (2 \pi \xi + \pi) \;\mathrm{mod}\; 2 \pi,
\end{align}
%
where $\xi \in \left[0,1\right)$ is a random number.
After an annihilation interaction, PROPOSAL returns the created photons and stops the particle propagation.

Figure \ref{fig:spectrum_annihilation} shows an energy spectrum of secondary particles produced by positrons where annihilation is enabled.
Since annihilation is always stochastic with $v=1$, the process is not influenced by the energy cut settings, resulting in stochastic losses with $E \cdot v < {E_\text{cut}}$.
Quantitatively, the annihilation interaction is, as well as the other processes, suppressed compared to bremsstrahlung processes.
However, for energy losses around $\SI{1}{\giga\electronvolt}$, a contribution to the secondary spectrum at a level of a few percent can be observed.

\begin{figure}
    \centering
    \includegraphics[scale=1]{build/spectrum_annihilation.pdf}
    \caption{Secondary particle energy spectrum for $\num{e5}$ positrons with an initial energy of $\SI{e8}{\mega\electronvolt}$, propagated in air. Electron-Positron annihilation is enabled. The histogram shows the frequency of the stochastic losses during propagation, classified by the type of energy loss. The energy cut applied here is $E_\text{cut} = \SI{500}{\mega\electronvolt}$. Note that the annihilation process is not affected by the cut settings since the relative energy transfer $v$ is always $1$.}
    \label{fig:spectrum_annihilation}
\end{figure}

\section{Photon propagation in PROPOSAL}

\label{sec:photonprop}

Since photons are massless and uncharged, their interactions differ strongly from interactions of electrons, muons and tauons.
Possible photon interactions are the production of electron-positron pairs, Compton scattering and the photoelectric effect.
While the implementation of the first two processes is described in the following sections, the photoelectric effect is neglected since its relevance is limited to energies $E \ll 2 m_e$.
However, photons with energies below $2 m_e$ are irrelevant for the further development of an electromagnetic shower due to their inability to produce secondary particles.

\subsection{Pair production by photons}

Photo pair production, called electron-positron pair production in the further course of this subsection (although not to be confused with the creation of an electron-positron pair by an incoming lepton), describes the creation of an electron-positron pair by an ingoing photon in the field of an atomic nucleus.
A Feynman diagram for the process is shown in figure \ref{fig:feynman_photopair}.
%
\begin{figure}
    \centering
    \input{content/feynman/feynman_photopair.tex}
    \caption{Feynman diagram in leading order for electron-positron pair production by an ingoing photon near a nucleus. The nucleus is necessary to conserve energy and momentum during the interaction.}
    \label{fig:feynman_photopair}
\end{figure}
%
Electron-positron pair production is the dominant interaction of photons in matter for energies above several $\si{\mega\electronvolt}$ and is therefore essential for the propagation of high energy photons.

\subsubsection{Theoretical description}

The process of electron-positron pair production is described by quantum electrodynamics and a differential cross section exact to order $\alpha^3$ is provided by \cite{RevModPhys.46.815}.
However, the evaluation of this expression is too complicated for a practical implementation.
Based on \cite[][Eq.~3.9]{RevModPhys.46.815}, an approximated expression is given by
%
\begin{equation}
	\label{eqn:crosssection_pairproduction}
	\begin{split}
	\frac{\symup{d}\sigma}{\symup{d}x} &= \frac{\alpha r_e^2 x E_{\gamma}}{p} \biggl\{ \left(\frac{4}{3} x^2 - \frac{4}{3} x + 1 \right) \\ &\quad\times \biggl[ Z^2 \left(\varphi_1 - \frac{4}{3} \ln(Z) - 4f(z) \right) + Z \left( \psi_1 - \frac{8}{3} \ln(Z) \right) \biggr]  \\ &\quad- \frac{2}{3} x (1 - x) \biggl[ Z^2 \left(\varphi_1 - \varphi_2\right) + Z \left(\psi_1 - \psi_2\right) \biggr] \biggr\}
	\end{split}
\end{equation}
%
with $x = \sfrac{E_{-}}{E_{\gamma}}$ where $E_{\gamma}$ is the energy of the initial photon, $E_-$ the energy of the produced electron and $p$ its absolute momentum.
The function $f(z)$ describes the Coulomb correction and is defined as
%
\begin{align}
	f(z) &= 1.202 z - 1.0369 z^2 + 1.008 \frac{z^3}{1+z}, & z &= \left(\frac{Z}{137}\right)^2.
\end{align}
%
While the approximate differential cross section ignores effects from nuclear form factors, which are only important for large production angles, the effects from the atomic form factors are described by the functions $\varphi_1$, $\varphi_2$ (elastic scattering part) and $\psi_1$, $\psi_2$ (inelastic scattering part).
The description used for the atomic form factors varies with $Z$, the resulting expressions for $\varphi$ and $\psi$ are given in appendix \ref{sec:atomic_form_factors}.

Since the photon must provide the rest mass of both the electron and the positron, the kinematic limits of the process are given by
%
\begin{align}
	E &\geq 2 m_e, & x_{\text{min}} &= \frac{m_e}{E_{\gamma}}, & x_{\text{max}} &= 1 - \frac{m_e}{E_{\gamma}}.
\end{align}
%
For high energies, the angles between the photon and the produced leptons are very small and its directions are dominated by multiple scattering effects rather than the initial production angles.
Therefore, it is sufficient to treat the calculation of the angular distribution of the electrons and positrons approximately.
An approximative double differential cross section describing the angular distribution based on \cite[][Eq.~3.5]{RevModPhys.46.815} is given by
%
\begin{equation}
	\label{eqn:angular_distribution}
	\begin{split}
	\frac{\symup{d}^2\sigma}{\symup{d}{\theta}\symup{d}{p}} &= \frac{2 \alpha^3 E_{-}^2}{\pi E_{\gamma} m_e^4} \sin(\theta) \biggl[ \left( \frac{2 x (1-x)}{(1 + l)^2} - \frac{12 l x (1-x)}{(1 + l)^4} \right) G_2(\infty) \\ &\quad+ \left( \frac{2 x^2 - 2x + 1}{(1 + l)^2} + \frac{4 l x (1-x)}{(1 + l)^4} \right) \left( X - 2 Z^2 f(z) \right) \biggr]
	\end{split}
\end{equation}
%
with
%
\begin{align*}
	l &= \frac{E_-^2 \theta^2}{m_e^2}, & G_2(\infty) = Z^2 + Z,
\end{align*}
%
and the angle $\theta$ between the initial photon and the produced electron.
The function $X$, describing the effects from the atomic form factors, varies with $Z$ and is defined in appendix \ref{sec:atomic_form_factors}.

\subsubsection{Implementation in PROPOSAL}

% sloppypar is needed here because otherwise \texttt{...} breaks the layout because it cant use hyphenation here
\begin{sloppypar}
The electron-positron pair production process for photons described in the previous section can be enabled in PROPOSAL by setting the keyword \texttt{photopair} in the configuration file to \texttt{PhotoPairTsai}.
\end{sloppypar}

Since the initial photon ceases to exist after the interaction and transfers its whole energy to the created electron-positron pair, the process is always stochastic with a relative energy transfer of $v=1$.
This requires, very similar to the annihilation process, which is the reverse process of pair production (see \ref{sec:annihilation} for a description), adjustments to the propagation algorithm of PROPOSAL.

To obtain the total stochastic cross section $\sigma_{\text{stoch}}$ for electron-positron pair production, the differential cross section \ref{eqn:crosssection_pairproduction} is integrated over the entire kinematic range of $x$.
While the relative energy transfer $v=1$ is already known, the parameter $x$ describing the asymmetry of the energy transfer needs to be sampled by solving the integral equation
%
\begin{equation}
	\frac{1}{\sigma_{\text{stoch}}} \int_{x_{\text{min}}}^{x} \frac{\symup{d}\sigma}{\symup{d}x} \, \symup{d}x = \xi
\end{equation}
%
for $x$ with a random number $\xi \in \left[0,1\right)$.
The energy of the electron $E_-$, respectively the energy of the positron $E_+$, is set to
%
\begin{align}
	E_- &= x E_{\gamma}, & E_+ &= (1-x) E_{\gamma}.
\end{align}
%

To offer different levels of accuracy in the simulation of the angular distribution, three different options can be used to describe the angles between the initial photon and the created electron and positron.
Firstly, the double-differential cross section \eqref{eqn:angular_distribution} can be used to sample the polar angle $\theta$ for both the electron and the positron by solving, once for each particle, the integral equation
%
\begin{equation}
	\label{eqn:angular_tsai}
    \left( \frac{\symup{d}\sigma}{\symup{d}p}(p^{\ast}) \right)^{-1} \int_{0}^{\theta} \frac{\mathrm{d}^2\sigma}{\mathrm{d}\theta \mathrm{d}p}(p^{\ast}) \, \symup{d}\theta = \xi
\end{equation}
%
for $\theta$ where $\xi \in \left[0,1\right)$ is a random number and $p = p^{\ast}$ the fixed absolute momentum of the electron, respectively the positron.
Alternatively, a simpler method suggested by \cite{Hirayama:2005zm} can be applied where the angle of both particles is set to
%
\begin{equation}
	\label{eqn:angular_egs}
	\theta = \frac{m_e}{E_{\gamma}}.
\end{equation}
%
For both methods, the azimuth angle $\Phi$ is sampled via
%
\begin{align}
	\Phi_{-} &= 2 \pi \xi, & \Phi_{+} &= (2 \pi \xi + \pi) \;\mathrm{mod}\; 2 \pi,
\end{align}
%
where $\xi \in \left[0,1\right)$ is an additional random number.

% sloppypar is needed here because otherwise \texttt{...} breaks the layout because it cant use hyphenation here
\begin{sloppypar}
To use the calculation of the production angles according to \eqref{eqn:angular_tsai}, the keyword \texttt{photoangle} in the configuration file can be set to \texttt{PhotoAngleTsaiIntegral}, to use the method from \eqref{eqn:angular_egs}, the keyword can be set to \texttt{PhotoAngleEGS}.
Per default, both particle inherit the direction of the initial photon, i.e.\ the production angle is neglected.
This behavior can be enabled explicitly by setting the keyword to \texttt{PhotoAngleNoDeflection}.
\end{sloppypar}

\subsection{Compton scattering}

Compton scattering describes the scattering of a photon by a charged particle, here an atomic electron, causing a deflection of the initial photon and a reduction of its energy.
A Feynman diagram for the interaction is shown in figure \ref{fig:feynman_compton}.
For photons with an energy between several $\SI{100}{\kilo\electronvolt}$ and several $\SI{10}{\mega\electronvolt}$, Compton scattering is the dominant interaction process.

\begin{figure}
    \centering
    \input{content/feynman/feynman_compton.tex}
    \caption{Feynman diagram in leading order for Compton scattering. The diagram shown here represents the $s$-channel contribution.}
    \label{fig:feynman_compton}
\end{figure}


\subsubsection{Theoretical description}

Under the assumption that the binding energy of the atomic electrons can be neglected, which is a good approximations especially for photon energies that are high enough to be relevant for shower propagation, i.e.\ $E > 2 m_e$, the differential cross section for Compton scattering is given by the Klein-Nishina formula \cite{KleinNishina}.
Based on the formulation of the Klein-Nishina formula in \cite{Hirayama:2005zm}, the differential cross section can be written as
%
\begin{equation}
	\frac{\symup{d}\sigma}{\symup{d}v} = \frac{Z \pi r_e^2 m_e}{E} \left( \frac{C_1}{\varepsilon^2} + \frac{C_2}{\varepsilon} + C_3 + \varepsilon \right)
\end{equation}
%
with
%
\begin{align}
	\varepsilon &= 1 - v, & C_1 &= \frac{m_e^2}{E^2}, \\
	C_2 &= 1 - 2 C_1 \left( 1 + \frac{E}{m_e} \right) , & C_3 &= C_1 \left( 1 + 2 \frac{E}{m_e} \right).
\end{align}
%
To obtain a relation between $\theta$, the angle between the initial photon and the scattered photon, and the involved energies, using \eqref{eqn:2to2process_angle} with
%
\begin{align*}
	E_1 &= E, & m_1 &= m_3 = 0, \\
	E_2 &= m_e, & m_2 &= m_4 = m_e, \\
	E_3 &= (1 - v) E \coloneqq E^{\prime},
\end{align*}
%
according to the kinematic for Compton scattering, yields
%
\begin{equation}
	\label{eqn:angle_compton}
	\cos(\theta) = 1 - \left( \frac{m_e}{E^{\prime}} - \frac{m_e}{E} \right).
\end{equation}
%
By solving \eqref{eqn:angle_compton} for $E^{\prime}$, the well-known relation
%
\begin{equation}
	E^{\prime} = \frac{E}{1 + \frac{E}{m_e} (1 - \cos(\theta))}
\end{equation}
%
can be obtained.
Setting $\cos(\theta) = \pm1$ in \eqref{eqn:angle_compton} yields the kinematic limits
%
\begin{align}
	v_{\text{min}} &= 0, & v_{\text{max}} &= \frac{1}{\frac{m_e}{2E} + 1},
\end{align}
%
for Compton scattering.

\subsubsection{Implementation in PROPOSAL}

% sloppypar is needed here because otherwise \texttt{...} breaks the layout because it cant use hyphenation here
\begin{sloppypar}
Compton scattering, as described in the previous section, can be enabled in PROPOSAL by setting the keyword \texttt{compton} in the configuration file to \texttt{ComptonKleinNishina}.
\end{sloppypar}
Figure \ref{fig:compton} shows the Klein-Nishina formula for several energies.
While the differential cross section is evenly distributed for small energies, a peak towards the forward direction can be seen for higher energies.

\begin{figure}
    \centering
    \includegraphics[scale=1]{build/compton.pdf}
    \caption{Plot of the differential cross section in $\cos(\theta)$ for Compton scattering according the Klein-Nishina formula for different photon energies. The angular coordinate determines the deflection angle of the initial photon, the radial axis describes the differential cross section in arbitrary units.}
    \label{fig:compton}
\end{figure}
\todo{Three variants for the plot: 1. Ticklabels behind the grid and plot, 2. Grid in front of the plot but tick labels in front of the plot, 3. Neglect the (arbitrary)  polar axis altogether}

To evaluate the integrals \eqref{eqn:fE}, \eqref{eqn:stoch_crosssection} and \eqref{eqn:sample_v} numerically for Compton scattering calculations, the substitution $t = \ln(1 - v)$ is used to avoid occurring numerical problems for $v \to 1$ at high energies.

In a stochastic Compton interaction, the initial photon is deflected by an polar angle $\theta$ according to \eqref{eqn:angle_compton} while the azimuth $\Phi$ is selected randomly in the range $\left[0,2\pi\right)$.

The total cross section for Compton scattering, compared to the total cross section for electron-positron pair production by photons, is shown in figure \ref{fig:compton_comparison}.
As expected, electron-positron pair production is the dominant photon interaction in matter for high energies with a transition to Compton scattering as the dominant process at an energy below about $\SI{20}{\mega\electronvolt}$.

\begin{figure}
    \centering
    \includegraphics[scale=1]{build/compare_compton.pdf}
    \caption{Total cross section of Compton scattering in comparison to the total cross sections of electron positron pair production for photons in air. The total cross section is obtained by setting $e_\text{cut} \approx 0$.}
    \label{fig:compton_comparison}
\end{figure}
\todo{I am not entirely sure about the units, and probably an overall factor for the numerical values is missing}

\section{Electromagnetic shower propagation with PROPOSAL}
\label{sec:proposal_showers}

With the improvement of electron and positron propagation, as described in section \ref{sec:electronprop}, as well as the implementation of photon propagation, as described in section \ref{sec:photonprop}, PROPOSAL can be used to simulate all particles essential for an electromagnetic shower.
As a proof of concept, the simulation of a simple electromagnetic shower with PROPOSAL as a model for electromagnetic interactions is presented.

\begin{algorithm}[H]
\DontPrintSemicolon
 particle list = [primary particle]\;
 shower data = [\:]\;
 \While{particle list not empty}{
  extract first element from particle list\;
  save information on extracted particle in shower data\;
  propagate extracted particle\;
  append all produced secondary particles to particle list\;
 }
 \caption{Simplified shower propagation algorithm.}
 \label{alg:shower}
\end{algorithm}

The basic algorithm used for the simulation of an electromagnetic shower is shown in algorithm \ref{alg:shower}.
While the general algorithm is implemented using a Python script, the step "propagate extracted particle" is conducted by PROPOSAL. 
It can be seen that the structure of the algorithm corresponds to a breadth-first search since particles that were first added to the list are also propagated first (\textbf{F}irst \textbf{I}n, \textbf{F}irst \textbf{O}ut principle).

For each stochastic interaction, the position of the stochastic interaction, the type of the particle causing the stochastic interaction, the energy of the initial particle before the stochastic interaction as well as the position of the previous stochastic interaction are saved in the shower data list.
This information can be used to reconstruct the shower development.
In the last step, electrons and positrons from pair production by photons, photons from electron-positron annihilation as well as bremsstrahlung photons created by electrons or positrons are taken from the PROPOSAL output and added to the particle list.
Other particles such as electrons and positrons from pair production by other leptons are neglected in this version of the algorithm.

The atmosphere for the simulated showers is described by homogeneous air with a density of $\rho = \SI{1.205}{\kilo\gram\per\cubic\centi\metre}$ corresponding to the properties of air at sea level.
Therefore, the variation of the density with altitude is not taken into account.
The primary particle for the electromagnetic shower is a photon initialized at a height of $z = \SI{10}{\kilo\metre}$ directed towards the ground at $z=\SI{0}{\kilo\metre}$ which is described as standard rock.
The cut settings for the propagation of all particles are set to $e_{\text{cut}} = \SI{50}{\mega\electronvolt}$ with no $v_{\text{cut}}$.

Figure \ref{fig:hex} and \ref{fig:hex_xy} show the track densities of two electromagnetic showers with different initial photon energies.
The plots are obtained by connecting the positions of two consecutive stochastic losses of a particle and plotting the resulting tracks in a high-resolution histogram.
Both the projection onto the $zy$-plane in figure \ref{fig:hex} and the projection onto the $xy$-plane in figure \ref{fig:hex_xy} show that the showers consist of a core with a very high particle density that decreases with distance from the initial shower axis.
In figure \ref{fig:hist_1e6} and figure \ref{fig:hist_1e7}, the shower profiles for both showers, i.e.\ the number of particles in the $xy$-plane as a function of the distance $z$ from the ground, are shown.

\begin{figure}
      \centering
      \subcaptionbox{Shower for an initial photon energy of $\SI{e6}{\mega\electronvolt}$.\label{fig:hex_1e6}}
        {\includegraphics[scale=1]{build/hex_1e6.png}}
        \hfill
      \subcaptionbox{Shower for an initial photon energy of $\SI{e7}{\mega\electronvolt}$.\label{fig:hex_1e7}}
        {\includegraphics[scale=1]{build/hex_1e7.png}}
      \caption{Two electromagnetic showers induced by a photon at $z=\SI{10}{\kilo\metre}$. The color bar describes the particle density (electrons, positrons and photons combined) in approximate counts. Only particle tracks with an energy above $\SI{50}{\mega\electronvolt}$ at the end of the track are shown. The shower has been projected onto the $zy$-plane in the laboratory frame.\label{fig:hex}}
\end{figure}

\begin{figure}
      \centering
      \subcaptionbox{Shower for an initial photon energy of $\SI{e6}{\mega\electronvolt}$.\label{fig:hex_1e6_xy}}
        {\includegraphics[scale=1]{build/hex_1e6_xy.png}}
        \hfill
      \subcaptionbox{Shower for an initial photon energy of $\SI{e7}{\mega\electronvolt}$.\label{fig:hex_1e7_xy}}
        {\includegraphics[scale=1]{build/hex_1e7_xy.png}}
      \caption{Two electromagnetic showers induced by a photon at $z=\SI{10}{\kilo\metre}$. The color bar describes the particle density (electrons, positrons and photons combined) in approximate counts. Only particle tracks with an energy above $\SI{50}{\mega\electronvolt}$ at the end of the track are shown. The shower has been projected onto the $xy$-plane in the laboratory frame.\label{fig:hex_xy}}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[scale=1]{build/hist_1e6.pdf}
    \caption{Shower profile of the electromagnetic shower with an initial photon energy of $\SI{e6}{\mega\electronvolt}$.}
    \label{fig:hist_1e6}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[scale=1]{build/hist_1e7.pdf}
    \caption{Shower profile of the electromagnetic shower with an initial photon energy of $\SI{e7}{\mega\electronvolt}$.}
    \label{fig:hist_1e7}
\end{figure}