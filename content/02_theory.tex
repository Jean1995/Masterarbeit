\chapter{Theory}

\section{The lepton propagator PROPOSAL}

PROPOSAL (\textbf{Pr}opagator with \textbf{o}ptimal \textbf{p}recision and \textbf{o}ptimized \textbf{s}peed for \textbf{a}ll \textbf{l}eptons) is a Monte Carlo simulation library capable of simulating the interactions of high energy leptons.
The original program called MMC (\textbf{M}uon \textbf{M}onte \textbf{C}arlo) has been written in the programming language Java focusing on a precise but also fast muon and tau propagation \cite{chirkin2004propagating}.
On this basis, MMC has been rewritten within a dissertation to create the \CC library PROPOSAL \cite{Kohne:2013zbq}.
To allow for a more universal use of the program, PROPOSAL can be used in Python through a wrapper as well.
More modern programming concepts such as polymorphism and a modular code structure were introduced in a recent update of PROPOSAL \cite{dunsch_2018_proposal_improvements}.

The current version of the code is publicly available on GitHub\footnote{\url{https://github.com/tudo-astroparticlephysics/PROPOSAL}} and can be used under the terms of a modified LGPL license.
Examples of applications are the neutrino observatories IceCube and RNO who use PROPOSAL as a part of their simulation chain.

\subsection{Calculation of energy losses}

Energy losses of particles form the basis for the propagation algorithm in PROPOSAL.
Assuming a particle with an initial energy $E_i$, an energy loss is determined by its absolute value

\begin{equation}
	\nu = E_i \cdot v
\end{equation}

where $v$ describes the relative energy loss of the particle and $E_f = E_i - \nu$ the final particle energy.
Processes that cause energy losses and are implemented in PROPOSAL are

\begin{itemize}
	\item bremsstrahlung,
	\item ionization,
	\item photonuclear interactions and
	\item pair production of an electron-positron pair.
\end{itemize}

Quantitatively, the interaction probability for a process is described by its cross section $\sigma$.
To describe the process with respect to a specific variable in the final state, the cross section can be written in a differential form, for example $\sfrac{\symup{d}\sigma}{\symup{d}v}$.

In principle, this information could be used right away to sample energy losses from differential cross sections, which are treated as probability density functions, by using inverse sampling.
However, this approach would cause two immediate problems:
Firstly the propagation process would be very time inefficient since small energy losses, especially below the energy threshold of a detector, would be sampled individually.
Secondly numerical problems could occur due to the nature of the bremsstrahlung interaction:
Since photons are massless, the bremsstrahlung cross sections diverges for $v \to 0$, making inverse sampling over the whole parameter range impossible.

As a solution, PROPOSAL differentiates between continuous and stochastic energy losses.
The energy cut parameter $v_\text{cut}$ is defined as

\begin{equation}
	\label{eqn:cut}
	v_\text{cut} = \text{min}\left[\sfrac{e_\text{cut}}{E}, v\prime_\text{cut} \right]
\end{equation}

with a relative energy cut $v\prime_\text{cut}$ and an absolute energy cut $e_\text{cut}$.
Energy losses with $v < v_\text{cut}$ are treated as continuous losses, energy losses with $v > v_\text{cut}$ are treated as stochastic losses.
The definition in \ref{eqn:cut} ensures that losses above an absolute detector threshold $e_\text{cut}$ are treated as stochastic even if their relative value is too small.

The propagation algorithm in PROPOSAL consists of numerous propagation steps where each step consists of continuous losses and a stochastic loss, see \ref{sec:algorithm} for a detailed description.
To perform one propagation step, it is therefore necessary to have a mathematical expression to sample stochastic losses.

Let $E_i$ be the initial energy of a particle and

\begin{equation}
	\label{eqn:cum}
	P\left(E_f \leq E \leq E_i\right) = - \int_{E_i}^{E_f} p(E) \, \symup{d}E
\end{equation}

a cumulative distribution function describing the probability for a stochastic loss at a particle energy $E \geq E_f$.
With inverse sampling, this function can be used to sample the energy of the occurrence of the next stochastic loss.

To derive an expression for \ref{eqn:cum}, the distance between the initial particle position $x_i$ and the position of the stochastic loss is discretized into sections of $\Delta x$.
The probability for a stochastic loss after a propagation distance of $x_f$, without any stochastic losses in the interval $\left(x_i, x_f\right)$, can be described as

\begin{equation}
	\label{eqn:discrete}
	\begin{split}
	\Delta P\left(x_f\right) &= P\left( x_f + \Delta x \right) - P\left( x_f \right)\\
	&= \left( 1 - \sigma(x_i) \Delta x \right) \cdot \left( 1 - \sigma(x_{i+1}) \Delta x \right) \cdot\ldots\cdot \left( 1 - \sigma(x_{f-1}) \Delta x \right) \cdot \sigma(x_f) \Delta x \\
	&\approx \exp \left( - \sum_{j=i}^{f-1} \sigma(x_j) \Delta x_j \right) \cdot \sigma(x_f) \Delta x\\
	\intertext{where $\Delta x \ll 1$ was used in the last step. In a differential form, this relation can be written as}
	\symup{d}P\left( x_f \right) &= \exp\left(-\int_{x_i}^{x_f} \sigma(x) \, \symup{d}x \right) \cdot \sigma(x_f) \, \symup{d} x_f.
	\end{split}
\end{equation}

To transfer the dependency on the location $x$ to a dependency on the energy $E$, the relation

\begin{equation}
	\label{eqn:fE}
	f(E) = -\frac{\symup{d}E}{\symup{d}x} = E \frac{N_A}{A} \int_{v_\text{min}}^{v_\text{cut}} \frac{\symup{d}\sigma}{\symup{d}v} \, \symup{d}v
\end{equation}

is introduced.
Here, $f(E)$ describes the continuous energy losses between two stochastic losses and is calculated by taking the average energy loss for all interactions below the energy cut $v_\text{cut}$.
Applying relation \ref{eqn:fE} on \ref{eqn:discrete} yields

\begin{equation}
	\label{eqn:discrete_energy}
	\symup{d}P\left(E_f\right) = \exp \left( \int_{E_i}^{E_f} \frac{\sigma(E)}{ f(E) } \, \symup{d}E \right) \cdot \frac{\sigma(E_f)}{-f(E_f)} \, \symup{d}E_f.
\end{equation}

The cumulative distribution function is obtained by integrating over the probabilities in \ref{eqn:discrete_energy}:

\begin{equation}
	\label{eqn:cum_detail}
	\begin{split}
	P\left(E_f \leq E \leq E_i\right) &= \int_{P(E_i)=0}^{P(E_f)} \symup{d}P(E_f)\\
	&= \int_{E_i}^{E_f} \exp \left( \int_{E_i}^{E_f'} \frac{\sigma(E)}{ f(E) } \, \symup{d}E \right) \cdot \frac{\sigma(E'_f)}{-f(E'_f)} \, \symup{d}E'_f.
	\end{split}
\end{equation}

The expression in \ref{eqn:cum_detail} is simplified by using the substitution

\begin{align}
	v(E) &= \int_{E_i}^{E} \frac{\sigma(E')}{f(E')} \, \symup{d}E', & \symup{d}v &= \frac{\sigma(E)}{f(E)} \, \symup{d}E
\end{align}

where the fundamental theorem of calculus has been applied to obtain the expression for $\symup{d}v$.
It follows that

\begin{equation}
	\label{eqn:cum_final}
	\begin{split}
	P\left(E_f \leq E \leq E_i\right) &= - \int_{E_i}^{E_f} \exp \left( v(E_f') \right) \, \symup{d}v \\
	&= \left[ \exp \left( v(E'_f) \right) \right]_{E_i}^{E_f}\\
	&= \exp\left( v(E_f) \right) - \underbrace{\exp \left( v(E_i) \right)}_{= 0} \\
	&= \exp{\left( \int_{E_i}^{E_f} \frac{\sigma(E)}{f(E)} \, \symup{d}E \right)}.
	\end{split}
\end{equation}

By replacing the probability $P$ in \ref{eqn:cum_final} by a random number $\xi \in \left(0, 1\right]$ we the energy integral

\begin{equation}
	\label{eqn:energy_integral}
	\int_{E_i}^{E_f} \frac{\sigma(E)}{-f(E)} \, \symup{d}E = - \log{\xi},
\end{equation}

originally derived in \cite{chirkin2004propagating}, is obtained. 
By sampling $\xi$, \ref{eqn:energy_integral} can be used to calculate the energy of the occurrence of the next stochastic loss.

\subsection{Propagation algorithm}
\label{sec:algorithm}

The task of the propagation algorithm of PROPOSAL is to simulate the properties of the secondary particles produced in interactions as well as the properties of the initial particle after each interaction.
This includes information on the energy, position, direction and time of the initial particle and the secondary particles.

On the technical note, the structure of the propagation process in PROPOSAL is determined by the concept of a "chain of responsibility".
Part of this chain are the \emph{Sector} objects and a \emph{Propagator} object.

Each \emph{Sector} is defined by its geometry, its medium, its energy cut settings and other sector-specific properties.
The cut settings itself differentiate between various particle positions with respect to a predefined \emph{Detector} geometry.
By having sectors with varying characteristics the user has the possibility to appropriately model the simulation environment.

The \emph{Propagator} object chooses which sector is responsible for the propagation of the particle at its current position.
The assigned \emph{Sector} then propagates the particle within its borders and returns the propagated particle back to the \emph{Propagator}.
This process is repeated either until the propagated distance of the initial particle surpasses a preset maximal propagation distance $d_\text{max}$ or until the initial particle energy falls below a preset threshold energy $e_\text{low}$.

The following steps give a simplified overview of the propagation process within a \emph{Sector}.

\textbf{Energy of next interaction}

According to \ref{eqn:energy_integral}, the energy of the occurrence of the next stochastic energy loss is calculated with a random number $\xi$.
If

\begin{equation}
	\xi > \exp{\left( \int_{E_i}^{e_\text{low}} \frac{\sigma(E)}{f(E)} \, \symup{d}E \right)}
\end{equation}

the sampled energy of the next stochastic loss would fall below the threshold energy $e_\text{low}$, in this case there is no stochastic loss.

Furthermore, based on the lifetime $\tau$ of the initial particle, an energy where the particle decays is sampled.
Both energy values are compared and the higher energy value, together with its interaction type (stochastic loss or decay), are used for the next step\footnote{If a decay is the next interaction, the step "Simulation of stochastic energy loss" is replaced accordingly by a decay method.}.

\textbf{Particle displacement}

Given the initial energy $E_i$ and the energy of the interaction $E_f$, the (straight-lined) displacement is calculated with the tracking integral

\begin{equation}
	\label{eqn:tracking_integral}
	x_f = x_i - \int_{E_i}^{E_f} \frac{\symup{d}E}{f(E)}
\end{equation}

where $x_f - x_i$ describes the propagated distance.
If the calculated propagated distance would exceed the distance to the sector border $d$, $E_f$ is recalculated by setting $x_f = x_i + d$ in \ref{eqn:tracking_integral} and solving the integral equation for $E_f$.
In this case, no interaction will occur at $E_f$.

The elapsed time it determined by the time integral 

\begin{equation}
	t_f = t_i + \int_{x_i}^{x_f} \frac{\symup{d}x}{v(x)} = t_i - \int_{E_i}^{E_f} \frac{\symup{d}E}{f(E)v(E)}
\end{equation}

with the particle velocity $v(E)$, or alternatively using the approximation $v=c$ with 

\begin{equation}
	t_f = t_i + \frac{x_f - x_i}{c}.
\end{equation}

Optionally, PROPOSAL can apply multiple scattering effects on the calculated displacement.
This changes the position of the next stochastic loss by applying a sampled deflection angle as well as the new direction of the particle.
Currently, three different parametrization for multiple scattering can be used in PROPOSAL:
A parametrization based on Molière's theory of multiple scattering as well as two parametrization based on a gaussian-like approximation of the Molière theory by Highland, see \cite{GeiselBrinck2013RevisionOT} for a detailed description of the scattering parametrization used in PROPOSAL. 

\textbf{Continuous energy losses and continuous randomization}

The energy loss between $E_i$ and $E_f$ is treated continuously according to formula \ref{eqn:fE}, meaning that the particle energy is set to $E = E_f$.
However, this can cause discontinuities in the energy spectrum as shown in figure \ref{fig:cont_rand}

\begin{figure}
    \centering
    \includegraphics[scale=1]{build/cont_rand.pdf}
    \caption[]{Energy spectrum of \num{e5} muons with a starting energy of \SI{e8}{\mega\electronvolt}, propagated in \SI{300}{\meter} of standard rock\footnotemark. The spectrum show the effects of an energy cut with or without continuous randomization.}
    \label{fig:cont_rand}
\end{figure}
\footnotetext{Standard rock means a material with $Z = 11$, $A=22$ and a density of $\rho = \SI{2.65}{\gram\per\centi\metre^3}$, see e.g.\ \cite{PhysRevD.98.030001} for a detailed list of material properties.}

For a sufficiently large $v_\text{cut}$, for example $v_\text{cut} = 0.05$ in figure \ref{fig:cont_rand}, a peak in the final muon energy spectrum appears.
This peaks corresponds to all muons without any stochastic losses within the propagation distance.
These particle all have the same energy loss since no random numbers were effectively used to calculate their final energy, meaning that no fluctuations of the continuous losses are taken into account.
Setting the energy cut to a significantly lower value, for example $\v_\text{cut} = \num{e-4}$ in \ref{fig:cont_rand}, eliminates this peaks, however the runtime for the propagation is increased by at least an order of magnitude.

As a more time-efficient solution the option \emph{continuous randomization} can be enabled in PROPOSAL.
This applies fluctuations on the continuous loss energy sampled from a gaussian distribution.
The mean of this distribution corresponds to $E_i - E_f$, the variance is calculated by

\begin{equation}
	\left< \Delta (\Delta E)^2 \right> = \int_{E_i}^{E_f} \frac{E^2}{-f(E)} \left< \frac{\symup{d}E^2}{\symup{d}x} \right>,
\end{equation}

where the derivation of the variance follows similar steps to the derivation of \ref{eqn:energy_integral}, see \cite{chirkin2004propagating} for a detailed derivation and description. 
The effects can be seen in \ref{fig:cont_rand}, the energy spectrum becomes continuous and the running time behaves similarly to the running time for the propagation without continuous randomization.

\textbf{Simulation of stochastic energy loss}

